// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // utilisée par l'app au runtime
  directUrl = env("DIRECT_URL") // utilisée par prisma migrate en prod
}

// --- ENUMS ---

enum AppointmentStatus {
  PENDING
  CONFIRMED
  RESCHEDULED
  CANCELLED
  REJECTED
  COMPLETED
}

enum AppointmentReason {
  DIAGNOSTIC
  INSTALLATION
  MAINTENANCE
  AUTRE
}

enum QuoteStatus {
  PENDING     // En attente de traitement
  PROCESSING  // En cours de traitement
  SENT        // Devis envoyé
  ACCEPTED    // Devis accepté
  REJECTED    // Devis refusé
  EXPIRED     // Devis expiré
}

// --- MODELS ---

model Contact {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String    @db.Citext
  phone     String?
  consentAt DateTime? @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  appointments Appointment[]
  quotes       Quote[]

  @@unique([email])
  @@index([lastName, firstName])
}

model Appointment {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  // Demande
  reason      AppointmentReason?
  reasonOther String?
  message     String?
  requestedAt DateTime           @db.Timestamptz(6)
  timezone    String             // Timezone de l'utilisateur lors de la demande (dynamique)

  // Planif
  status      AppointmentStatus @default(PENDING)
  scheduledAt DateTime?         @db.Timestamptz(6)

  // Self-service (tokens opaques envoyés via header)
  confirmationToken String    @unique
  cancellationToken String    @unique
  confirmedAt       DateTime? @db.Timestamptz(6)
  cancelledAt       DateTime? @db.Timestamptz(6)

  // Traces
  createdIp String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  emailLogs EmailLog[]
  reminder Reminder?

  // Empêcher deux RDV planifiés au même instant pour un même contact
  @@unique([contactId, scheduledAt])
  @@index([contactId])
  @@index([status, scheduledAt])
  @@index([scheduledAt])
}

model EmailLog {
  id            String       @id @default(cuid())
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  quoteId       String?
  quote         Quote?       @relation(fields: [quoteId], references: [id])
  to            String       @db.Citext
  subject       String
  template      String
  sentAt        DateTime     @default(now()) @db.Timestamptz(6)
  meta          Json?
}

model Reminder {
  id            String      @id @default(cuid())
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  dueAt         DateTime    @db.Timestamptz(6)
  sentAt        DateTime?   @db.Timestamptz(6)
  providerRef   String?
  createdAt     DateTime    @default(now()) @db.Timestamptz(6)
}

model Quote {
  id        String @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  // Demande initiale 
  projectDescription String      // Description du projet d'automatisme
  acceptPhone        Boolean     @default(false) // Accepte contact téléphonique
  acceptTerms        Boolean     // Acceptation des CGU
  
  // Statut et workflow 
  status QuoteStatus @default(PENDING)
  
  // Réponse du devis 
  quoteValidUntil DateTime? @db.Timestamptz(6) // Date d'expiration
  quoteDocument  String?  // URL ou chemin vers le document PDF (optionnel)
  
  // Gestion du rejet
  rejectionReason String? // Raison du refus (si status = REJECTED)
  
  // Traçabilité 
  processedAt DateTime? @db.Timestamptz(6) // Date de traitement
  sentAt      DateTime? @db.Timestamptz(6) // Date d'envoi du devis
  respondedAt DateTime? @db.Timestamptz(6) // Date de réponse client
  
  // Métadonnées système
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations avec les logs d'emails
  emailLogs EmailLog[]

  // Index pour les performances
  @@index([contactId])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique @db.Citext
  password  String
  firstName String
  lastName  String
  role      String   @default("ADMIN")
  isActive  Boolean  @default(true)
  lastLogin DateTime? @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([email])
  @@index([role])
}

model EmailActionToken {
  id        String   @id @default(cuid())
  token     String   @unique
  type      String   // 'appointment' ou 'quote'
  entityId  String   // ID de l'entité concernée
  action    String   // 'accept', 'reject', 'reschedule', etc.
  isUsed    Boolean  @default(false)
  usedAt    DateTime? @db.Timestamptz(6)
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([token])
  @@index([type, entityId])
  @@index([expiresAt])
}
